<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Player - The Future of Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #00ffff;
            --bg-color-start: #1e1b4b;
            --bg-color-end: #0c0a1d;
        }
        body {
            font-family: 'Poppins', sans-serif;
            color: #e0e0e0;
            background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-end));
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite;
            transition: background 1s ease;
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .player-card {
            background: rgba(10, 10, 20, 0.55);
            -webkit-backdrop-filter: blur(30px);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #4a4a6a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a8a; }

        .progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color); transition: background 0.2s ease-in-out; }

        #volume-slider { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100px; }
        #volume-slider::-webkit-slider-runnable-track { height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -5px; width: 14px; height: 14px; background: #fff; border-radius: 50%; }
        #volume-slider:focus::-webkit-slider-thumb { box-shadow: 0 0 5px var(--glow-color); }

        .control-button:hover svg, .active-button svg { filter: drop-shadow(0 0 8px var(--glow-color)); color: var(--glow-color) !important; }
        .play-button:hover, .play-button:focus { background-color: var(--glow-color); box-shadow: 0 0 15px var(--glow-color), 0 0 30px var(--glow-color); color: #111; }
        
        #album-art-container { perspective: 1000px; cursor: grab; }
        #album-art-container:active { cursor: grabbing; }
        #visualizer { transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        .playlist-item.active { background-color: rgba(0, 255, 255, 0.1); border-left-color: var(--glow-color); }

        .feature-button { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .feature-button:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .feature-button svg { transition: all 0.3s ease; }
        .feature-button:hover svg { filter: drop-shadow(0 0 8px var(--glow-color)); color: var(--glow-color); }
        
        #jam-session-modal {
            background: rgba(10, 10, 20, 0.8);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 overflow-hidden">


    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl p-8 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-2xl font-bold mb-2" id="auth-modal-title">Login</h3>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="auth-username" placeholder="Username" class="w-full bg-gray-800 text-white p-2 rounded-md border border-gray-700">
                <input type="email" id="auth-email" placeholder="Email" class="w-full bg-gray-800 text-white p-2 rounded-md border border-gray-700">
                <input type="password" id="auth-password" placeholder="Password" class="w-full bg-gray-800 text-white p-2 rounded-md border border-gray-700">
                <button type="submit" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-2 px-4 rounded-lg w-full transition-colors">Continue</button>
            </form>
            <button id="toggle-auth-mode" class="text-cyan-400 mt-2">Switch to Signup</button>
            <button id="close-auth-modal" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg w-full mt-2 transition-colors">Close</button>
        </div>
    </div>

    <!-- Mic Sing-Along & Live Listen -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col items-end space-y-2">
        <button id="mic-sing-button" class="feature-button p-3 rounded-full shadow-lg" title="Sing Along">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12v-2a4 4 0 0 1 8 0v2"></path><line x1="12" y1="16" x2="12" y2="22"></line></svg>
        </button>
        <button id="listen-live-button" class="feature-button p-3 rounded-full shadow-lg" title="Listen to Others">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline></svg>
        </button>
    </div>

    <video id="video-feed" class="hidden absolute"></video>

    <div class="w-full max-w-4xl player-card rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
        <!-- Left Side: Player -->
        <div class="w-full md:w-1/2 p-6 md:p-8 flex flex-col items-center justify-between">
            <div class="w-full flex justify-between items-center mb-4">
                 <button id="vibe-sync-button" class="feature-button p-2 rounded-full" title="Vibe Sync">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"></path><path d="M12 21v2"></path><path d="M4.22 4.22l1.42 1.42"></path><path d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"></path><path d="M21 12h2"></path><path d="M4.22 19.78l1.42-1.42"></path><path d="M18.36 5.64l1.42-1.42"></path></svg>
                 </button>
                 <h2 class="text-sm font-semibold text-cyan-300 uppercase tracking-widest">NOW PLAYING</h2>
                 <button id="jam-session-button" class="feature-button p-2 rounded-full" title="Jam Session">
                     <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a5 5 0 0 0-10 0"></path><line x1="12" y1="2" x2="12" y2="13"></line><line x1="4" y1="8" x2="10" y2="8"></line><line x1="14" y1="8" x2="20" y2="8"></line></svg>
                 </button>
            </div>
            
            <div id="album-art-container" class="w-full max-w-[280px] aspect-square mb-6">
                <canvas id="visualizer"></canvas>
            </div>

            <div class="w-full text-center mb-5">
                <h1 id="song-title" class="text-2xl lg:text-3xl font-bold truncate">Select a song</h1>
                <p id="artist-name" class="text-base text-gray-400 truncate">from the playlist</p>
            </div>
            
            <div class="w-full mb-2">
                <input type="range" id="progress-bar" class="progress-bar" value="0" min="0" max="100" step="0.1">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="w-full flex items-center justify-center space-x-6 mt-4">
                <button id="shuffle-button" class="control-button text-gray-400 hover:text-white transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="16 16 21 16 21 21"></polyline><line x1="4" y1="4" x2="15" y2="15"></line></svg></button>
                <button id="prev-button" class="control-button text-gray-300 hover:text-white transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
                <button id="play-pause-button" class="play-button bg-white text-gray-900 w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 transform hover:scale-110"><svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg></button>
                <button id="next-button" class="control-button text-gray-300 hover:text-white transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
                <button id="repeat-button" class="control-button text-gray-400 hover:text-white transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg></button>
            </div>

            <div class="flex items-center space-x-2 mt-6 w-full max-w-xs">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.75">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
            </div>
        </div>

        <!-- Right Side: Playlist -->
        <div class="w-full md:w-1/2 bg-black bg-opacity-20 p-6 md:p-8">
            <h2 class="text-xl font-bold mb-4">Playlist</h2>
            <div id="playlist" class="h-96 md:h-full overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Jam Session Modal -->
    <div id="jam-session-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-sm w-full text-center shadow-lg">
            <h3 class="text-2xl font-bold mb-2">Jam Session</h3>
            <p class="text-gray-400 mb-4">Share this link with your friends to listen together!</p>
            <input id="jam-session-link" type="text" readonly class="w-full bg-gray-900 text-center text-cyan-300 p-2 rounded-md border border-gray-700 mb-4">
            <button id="copy-jam-link-button" class="bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-2 px-4 rounded-lg w-full mb-2 transition-colors">Copy Link</button>
            <button id="close-jam-modal-button" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg w-full transition-colors">Close</button>
        </div>
    </div>

    <audio id="audio" src="" crossorigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Auth Modal Logic ---
            const authModal = document.getElementById('auth-modal');
            const authForm = document.getElementById('auth-form');
            const toggleAuthMode = document.getElementById('toggle-auth-mode');
            const closeAuthModal = document.getElementById('close-auth-modal');
            const authModalTitle = document.getElementById('auth-modal-title');
            let isSignup = false;

            function openAuthModal(signup = false) {
                isSignup = signup;
                authModal.classList.remove('hidden');
                authModalTitle.textContent = signup ? 'Signup' : 'Login';
                toggleAuthMode.textContent = signup ? 'Switch to Login' : 'Switch to Signup';
                document.getElementById('auth-email').style.display = signup ? 'block' : 'none';
            }
            toggleAuthMode.addEventListener('click', () => openAuthModal(!isSignup));
            closeAuthModal.addEventListener('click', () => authModal.classList.add('hidden'));
            // For prototype: just store username in localStorage
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('auth-username').value;
                if (isSignup) {
                    localStorage.setItem('vibeplayer_user', username);
                    alert('Signup successful!');
                } else {
                    localStorage.setItem('vibeplayer_user', username);
                    alert('Login successful!');
                }
                authModal.classList.add('hidden');
            });
            // Show login on first load if not logged in
            if (!localStorage.getItem('vibeplayer_user')) {
                openAuthModal(false);
            }

            // --- Mic Sing-Along Feature ---
            const micSingButton = document.getElementById('mic-sing-button');
            let micStream;
            micSingButton.addEventListener('click', async () => {
                if (!micStream) {
                    try {
                        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const micSource = audioCtx.createMediaStreamSource(micStream);
                        micSource.connect(audioCtx.destination);
                        micSingButton.classList.add('active-button');
                        micSingButton.title = 'Mic On - Singing!';
                        alert('Mic is live! Sing along.');
                    } catch (err) {
                        alert('Mic access denied.');
                    }
                } else {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                    micSingButton.classList.remove('active-button');
                    micSingButton.title = 'Sing Along';
                }
            });

            // --- Listen to Others Feature (Prototype) ---
            const listenLiveButton = document.getElementById('listen-live-button');
            listenLiveButton.addEventListener('click', () => {
                alert('Prototype: In future, you will be able to listen to others singing live!');
            });
            // --- Elements ---
            const audio = document.getElementById('audio');
            const playPauseButton = document.getElementById('play-pause-button');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const shuffleButton = document.getElementById('shuffle-button');
            const repeatButton = document.getElementById('repeat-button');
            const progressBar = document.getElementById('progress-bar');
            const volumeSlider = document.getElementById('volume-slider');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const songTitleEl = document.getElementById('song-title');
            const artistNameEl = document.getElementById('artist-name');
            const playlistEl = document.getElementById('playlist');
            const visualizerCanvas = document.getElementById('visualizer');
            const vibeSyncButton = document.getElementById('vibe-sync-button');
            const videoFeed = document.getElementById('video-feed');
            const jamSessionButton = document.getElementById('jam-session-button');
            const jamSessionModal = document.getElementById('jam-session-modal');
            const jamSessionLink = document.getElementById('jam-session-link');
            const copyJamLinkButton = document.getElementById('copy-jam-link-button');
            const closeJamModalButton = document.getElementById('close-jam-modal-button');
            
            let songs = [];

            // --- State ---
            let currentSongIndex = 0;
            let isPlaying = false;
            let isShuffle = false;
            let isRepeat = false;
            let audioContext, analyser, source, dataArray;
            let isVisualizerSetup = false;

            // --- Fetch Songs from Backend ---
            async function fetchSongs() {
                try {
                    const response = await fetch('http://localhost:3000/api/music');
                    if (!response.ok) {
                        throw new Error('Failed to fetch songs from the server.');
                    }
                    const fetchedSongs = await response.json();
                    // The backend returns snake_case, but the frontend expects camelCase for URLs.
                    songs = fetchedSongs.map(song => ({
                        ...song,
                        image: song.banner_url,
                        url: song.audio_url
                    }));
                    
                    if (songs.length > 0) {
                        renderPlaylist();
                        loadSong(0);
                    } else {
                        songTitleEl.textContent = "No songs found";
                        artistNameEl.textContent = "Please upload music to the database";
                    }
                } catch (error) {
                    console.error("Error fetching songs:", error);
                    songTitleEl.textContent = "Error loading songs";
                    artistNameEl.textContent = "Could not connect to backend";
                }
            }

            // --- 3D Visualizer Setup ---
            let scene, camera, renderer, particleSystem;
            let targetRotationX = 0, targetRotationY = 0;

            function createParticleTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, canvas.width / 2
                );
                gradient.addColorStop(0, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.2, 'rgba(255,255,255,0.8)');
                gradient.addColorStop(0.7, 'rgba(255,255,255,0.1)');
                gradient.addColorStop(1, 'rgba(255,255,255,0)');
                context.fillStyle = gradient;
                context.fillRect(0, 0, canvas.width, canvas.height);
                return new THREE.CanvasTexture(canvas);
            }

            function init3DVisualizer() {
                scene = new THREE.Scene();
                const container = document.getElementById('album-art-container');
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas: visualizerCanvas, alpha: true });
                renderer.setSize(container.clientWidth, container.clientHeight);

                const particles = 5000;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particles * 3);
                
                const radius = 1.5;
                for (let i = 0; i < positions.length; i += 3) {
                    const u = Math.random();
                    const v = Math.random();
                    const theta = 2 * Math.PI * u;
                    const phi = Math.acos(2 * v - 1);
                    positions[i] = radius * Math.sin(phi) * Math.cos(theta);
                    positions[i + 1] = radius * Math.sin(phi) * Math.sin(theta);
                    positions[i + 2] = radius * Math.cos(phi);
                }

                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                const material = new THREE.PointsMaterial({
                    color: 0x00ffff,
                    size: 0.05,
                    map: createParticleTexture(),
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    transparent: true
                });

                particleSystem = new THREE.Points(geometry, material);
                scene.add(particleSystem);
                camera.position.z = 3;

                container.addEventListener('pointerdown', onPointerDown);
                container.addEventListener('pointerup', onPointerUp);
                container.addEventListener('pointermove', onPointerMove);
            }
            
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            function onPointerDown(event) {
                isDragging = true;
                previousMousePosition = { x: event.clientX, y: event.clientY };
            }

            function onPointerUp() {
                isDragging = false;
            }

            function onPointerMove(event) {
                if (!isDragging) return;
                const deltaMove = {
                    x: event.clientX - previousMousePosition.x,
                    y: event.clientY - previousMousePosition.y
                };
                
                targetRotationY += deltaMove.x * 0.01;
                targetRotationX += deltaMove.y * 0.01;

                previousMousePosition = { x: event.clientX, y: event.clientY };
            }

            function animate3D() {
                requestAnimationFrame(animate3D);
                if (particleSystem) {
                    particleSystem.rotation.x += (targetRotationX - particleSystem.rotation.x) * 0.1;
                    particleSystem.rotation.y += (targetRotationY - particleSystem.rotation.y) * 0.1;

                    if (!isDragging) {
                       targetRotationY += 0.002;
                    }

                    if(isPlaying && dataArray && dataArray.length > 0) {
                        let sum = dataArray.slice(0, dataArray.length / 4).reduce((a, b) => a + b, 0); // Bass
                        let avg = sum / (dataArray.length / 4);
                        let scale = 1 + avg / 256;
                        particleSystem.scale.set(scale, scale, scale);
                    } else if (particleSystem.scale.x > 1) {
                         particleSystem.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
                    }
                }
                if (renderer) renderer.render(scene, camera);
            }

            // --- Functions ---
            function loadSong(index) {
                const song = songs[index];
                songTitleEl.textContent = song.title;
                artistNameEl.textContent = song.artist;
                audio.src = song.url;
                currentSongIndex = index;
                const songColor = song.color || '#00ffff';
                document.documentElement.style.setProperty('--glow-color', songColor);
                if (particleSystem) {
                    particleSystem.material.color.set(songColor);
                }
                updateActivePlaylistItem();
                if(isPlaying) playSong();
            }

            function playSong() {
                if(audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                if (!isVisualizerSetup) setupAudioApi();
                audio.play();
                isPlaying = true;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }

            function pauseSong() {
                audio.pause();
                isPlaying = false;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }

            function togglePlayPause() { isPlaying ? pauseSong() : playSong(); }

            function nextSong() {
                if (isShuffle) {
                    let newIndex;
                    do { newIndex = Math.floor(Math.random() * songs.length); } while (newIndex === currentSongIndex);
                    currentSongIndex = newIndex;
                } else {
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                loadSong(currentSongIndex);
            }

            function prevSong() {
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                loadSong(currentSongIndex);
            }

            function updateProgress() {
                if (audio.duration) {
                    progressBar.value = (audio.currentTime / audio.duration) * 100;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                }
            }

            function setProgressFromRange() { if (audio.duration) audio.currentTime = (progressBar.value / 100) * audio.duration; }
            function updateDuration() { if (!isNaN(audio.duration)) durationEl.textContent = formatTime(audio.duration); }
            function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }
            function toggleShuffle() { isShuffle = !isShuffle; shuffleButton.classList.toggle('active-button', isShuffle); }
            function toggleRepeat() { isRepeat = !isRepeat; audio.loop = isRepeat; repeatButton.classList.toggle('active-button', isRepeat); }
            function handleSongEnd() { if (!isRepeat) nextSong(); }
            function updateVolume() { audio.volume = volumeSlider.value; }
            function renderPlaylist() {
                playlistEl.innerHTML = '';
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.className = 'playlist-item flex items-center p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-white hover:bg-opacity-10 border-l-4 border-transparent';
                    item.dataset.index = index;
                    item.innerHTML = `<img src="${song.image}" alt="${song.title}" class="w-12 h-12 rounded-md object-cover mr-4"><div class="flex-grow"><p class="font-semibold text-white">${song.title}</p><p class="text-sm text-gray-400">${song.artist}</p></div>`;
                    item.addEventListener('click', () => loadSong(index));
                    playlistEl.appendChild(item);
                });
            }
            function updateActivePlaylistItem() {
                document.querySelectorAll('.playlist-item').forEach(item => {
                    item.classList.remove('active');
                    if (parseInt(item.dataset.index) === currentSongIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            }

            function setupAudioApi() {
                if (isVisualizerSetup) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    analyser.fftSize = 256;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    isVisualizerSetup = true;
                    updateAudioData();
                } catch(e) { console.error("Web Audio API not supported.", e); }
            }
            function updateAudioData() {
                if (isVisualizerSetup) {
                    analyser.getByteFrequencyData(dataArray);
                }
                requestAnimationFrame(updateAudioData);
            }

            // --- Vibe Sync ---
            async function vibeSync() {
                const moods = ['happy', 'calm', 'energetic'];
                const detectedMood = moods[Math.floor(Math.random() * moods.length)];
                
                const theme = moodThemes[detectedMood] || moodThemes.default;
                document.documentElement.style.setProperty('--glow-color', theme.glow);
                document.documentElement.style.setProperty('--bg-color-start', theme.bgStart);
                document.documentElement.style.setProperty('--bg-color-end', theme.bgEnd);
                
                const matchingSong = songs.findIndex(s => s.mood === detectedMood);
                if (matchingSong !== -1) {
                    loadSong(matchingSong);
                }
            }
            
            // --- Jam Session ---
            function startJamSession() {
                const sessionId = Math.random().toString(36).substring(2, 10);
                const link = `${window.location.href.split('?')[0]}?jam=${sessionId}&song=${currentSongIndex}&time=${audio.currentTime}`;
                jamSessionLink.value = link;
                jamSessionModal.classList.remove('hidden');
            }

            function handleJamSessionURL() {
                const params = new URLSearchParams(window.location.search);
                if(params.has('jam') && params.has('song')) {
                    const songIndex = parseInt(params.get('song'));
                    const time = parseFloat(params.get('time'));
                    if(songIndex >= 0 && songIndex < songs.length) {
                        loadSong(songIndex);
                        audio.currentTime = time;
                        playSong();
                    }
                }
            }

            // --- Event Listeners ---
            playPauseButton.addEventListener('click', togglePlayPause);
            nextButton.addEventListener('click', nextSong);
            prevButton.addEventListener('click', prevSong);
            shuffleButton.addEventListener('click', toggleShuffle);
            repeatButton.addEventListener('click', toggleRepeat);
            audio.addEventListener('timeupdate', updateProgress);
            progressBar.addEventListener('input', setProgressFromRange);
            audio.addEventListener('loadedmetadata', updateDuration);
            audio.addEventListener('ended', handleSongEnd);
            volumeSlider.addEventListener('input', updateVolume);
            vibeSyncButton.addEventListener('click', vibeSync);
            jamSessionButton.addEventListener('click', startJamSession);
            closeJamModalButton.addEventListener('click', () => jamSessionModal.classList.add('hidden'));
            copyJamLinkButton.addEventListener('click', () => {
                jamSessionLink.select();
                document.execCommand('copy');
                copyJamLinkButton.textContent = "Copied!";
                setTimeout(() => copyJamLinkButton.textContent = "Copy Link", 2000);
            });

            // --- Initial Load ---
            init3DVisualizer();
            animate3D();
            fetchSongs(); // Fetch songs from the backend on load
            updateVolume();
            handleJamSessionURL();
        // End of DOMContentLoaded
        });
    </script>
</body>
</html>

